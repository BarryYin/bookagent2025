<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆæ¨èç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 40px;
        }
        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .recommendation-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f9f9f9;
        }
        .book-title {
            font-size: 18px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 8px;
        }
        .book-meta {
            color: #666;
            margin-bottom: 10px;
        }
        .recommendation-reason {
            background: #e0f2fe;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #0277bd;
            margin-top: 10px;
        }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.active { background: #dcfce7; color: #166534; }
        .status.inactive { background: #fef2f2; color: #991b1b; }
        .metadata {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .btn {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– å¢å¼ºç‰ˆæ¨èç³»ç»Ÿæµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æˆ‘ä»¬çš„å¢å¼ºç‰ˆæ¨èç³»ç»Ÿæ•´åˆæ•ˆæœï¼Œå±•ç¤ºç”¨æˆ·ç”»åƒå’Œæ™ºèƒ½æ¨èçš„èåˆã€‚</p>
        
        <div class="section">
            <button class="btn" onclick="loadUserProfile()">è·å–ç”¨æˆ·ç”»åƒ</button>
            <button class="btn" onclick="loadEnhancedRecommendations()">è·å–å¢å¼ºæ¨è</button>
            <button class="btn" onclick="loadRecommendationContext()">è·å–æ¨èä¸Šä¸‹æ–‡</button>
            <button class="btn" onclick="startAgentChat()">å¯åŠ¨æ™ºèƒ½ä½“å¯¹è¯</button>
        </div>
    </div>

    <!-- ç”¨æˆ·ç”»åƒå±•ç¤º -->
    <div class="container" id="userProfileSection" style="display: none;">
        <h2>ğŸ“Š ç”¨æˆ·é˜…è¯»ç”»åƒ</h2>
        <div id="userProfileContent"></div>
    </div>

    <!-- å¢å¼ºæ¨èå±•ç¤º -->
    <div class="container" id="recommendationsSection" style="display: none;">
        <h2>ğŸ“š å¢å¼ºç‰ˆæ¨èç»“æœ</h2>
        <div id="recommendationsContent"></div>
    </div>

    <!-- æ¨èä¸Šä¸‹æ–‡å±•ç¤º -->
    <div class="container" id="contextSection" style="display: none;">
        <h2>ğŸ¯ æ¨èä¸Šä¸‹æ–‡</h2>
        <div id="contextContent"></div>
    </div>

    <!-- æ™ºèƒ½ä½“å¯¹è¯å±•ç¤º -->
    <div class="container" id="agentSection" style="display: none;">
        <h2>ğŸ’¬ æ™ºèƒ½ä½“å¯¹è¯</h2>
        <div id="agentContent"></div>
        <div style="margin-top: 20px;">
            <input type="text" id="userMessage" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." 
                   style="width: 70%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            <button class="btn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•çŠ¶æ€ï¼ˆå®é™…åº”ç”¨ä¸­ä»è®¤è¯ç³»ç»Ÿè·å–ï¼‰
        const mockUser = { id: 1, name: "æµ‹è¯•ç”¨æˆ·" };

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                return { error: error.message };
            }
        }

        async function loadUserProfile() {
            const section = document.getElementById('userProfileSection');
            const content = document.getElementById('userProfileContent');
            
            content.innerHTML = '<div class="loading">æ­£åœ¨è·å–ç”¨æˆ·ç”»åƒ...</div>';
            section.style.display = 'block';
            
            const data = await makeRequest('/api/user/reading-profile');
            
            if (data.error) {
                content.innerHTML = `<div class="error">è·å–å¤±è´¥: ${data.error}</div>`;
                return;
            }
            
            const profile = data.profile;
            if (!profile) {
                content.innerHTML = '<div class="error">ç”¨æˆ·ç”»åƒæ•°æ®ä¸ºç©º</div>';
                return;
            }
            
            content.innerHTML = `
                <div class="profile-item">
                    <span>ç”¨æˆ·ID:</span>
                    <span>${profile.user_id}</span>
                </div>
                <div class="profile-item">
                    <span>ç”Ÿæˆä¹¦ç±æ•°é‡:</span>
                    <span>${profile.total_books_generated} æœ¬</span>
                </div>
                <div class="profile-item">
                    <span>æµè§ˆä¹¦ç±æ•°é‡:</span>
                    <span>${profile.total_books_viewed} æœ¬</span>
                </div>
                <div class="profile-item">
                    <span>é˜…è¯»é¢‘ç‡:</span>
                    <span class="status ${profile.recent_activity ? 'active' : 'inactive'}">${profile.generation_frequency}</span>
                </div>
                <div class="profile-item">
                    <span>åˆ†ç±»å¤šæ ·æ€§:</span>
                    <span>${(profile.category_diversity * 100).toFixed(1)}%</span>
                </div>
                <div class="profile-item">
                    <span>æœ€è¿‘æ´»è·ƒ:</span>
                    <span class="status ${profile.recent_activity ? 'active' : 'inactive'}">${profile.recent_activity ? 'æ˜¯' : 'å¦'}</span>
                </div>
                <div class="profile-item">
                    <span>ä¸»è¦åˆ†ç±»åå¥½:</span>
                    <span>${Object.keys(profile.preferred_categories).slice(0, 3).join(', ') || 'æš‚æ— '}</span>
                </div>
                <div class="profile-item">
                    <span>æ’é™¤ä¹¦ç±æ•°é‡:</span>
                    <span>${profile.excluded_books_count} æœ¬</span>
                </div>
            `;
        }

        async function loadEnhancedRecommendations() {
            const section = document.getElementById('recommendationsSection');
            const content = document.getElementById('recommendationsContent');
            
            content.innerHTML = '<div class="loading">æ­£åœ¨è·å–å¢å¼ºæ¨è...</div>';
            section.style.display = 'block';
            
            const data = await makeRequest('/api/recommendations/enhanced?limit=5');
            
            if (data.error) {
                content.innerHTML = `<div class="error">è·å–å¤±è´¥: ${data.error}</div>`;
                return;
            }
            
            const recommendations = data.recommendations || [];
            const explanations = data.explanations || [];
            const metadata = data.recommendation_metadata || {};
            
            let html = '';
            
            if (recommendations.length === 0) {
                html = '<div class="error">æš‚æ— æ¨èæ•°æ®</div>';
            } else {
                recommendations.forEach((book, index) => {
                    const explanation = explanations[index] || 'æš‚æ— æ¨èç†ç”±';
                    html += `
                        <div class="recommendation-card">
                            <div class="book-title">${book.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
                            <div class="book-meta">
                                ä½œè€…ï¼š${book.author || 'æœªçŸ¥'} | 
                                åˆ†ç±»ï¼š${book.category_name || 'æœªåˆ†ç±»'} |
                                æ’åï¼šç¬¬ ${index + 1} ä½
                            </div>
                            <div class="recommendation-reason">
                                <strong>æ¨èç†ç”±ï¼š</strong>${explanation}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                <div class="metadata">
                    <h3>æ¨èå…ƒæ•°æ®</h3>
                    <div class="profile-item">
                        <span>æ¨èç­–ç•¥:</span>
                        <span>${metadata.strategy_used || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="profile-item">
                        <span>ç½®ä¿¡åº¦:</span>
                        <span>${metadata.confidence_score || 0}</span>
                    </div>
                    <div class="profile-item">
                        <span>æ•°æ®æº:</span>
                        <span>${metadata.data_source || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="profile-item">
                        <span>ç”¨æˆ·æ€»ä¹¦ç±:</span>
                        <span>${metadata.total_user_books || 0} æœ¬</span>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        async function loadRecommendationContext() {
            const section = document.getElementById('contextSection');
            const content = document.getElementById('contextContent');
            
            content.innerHTML = '<div class="loading">æ­£åœ¨è·å–æ¨èä¸Šä¸‹æ–‡...</div>';
            section.style.display = 'block';
            
            const data = await makeRequest('/api/recommendation/context');
            
            if (data.error) {
                content.innerHTML = `<div class="error">è·å–å¤±è´¥: ${data.error}</div>`;
                return;
            }
            
            const context = data.context || 'æš‚æ— ä¸Šä¸‹æ–‡æ•°æ®';
            
            content.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; line-height: 1.6;">
${context}
                </div>
            `;
        }

        let agentSessionActive = false;

        async function startAgentChat() {
            const section = document.getElementById('agentSection');
            const content = document.getElementById('agentContent');
            
            content.innerHTML = '<div class="loading">æ­£åœ¨å¯åŠ¨æ™ºèƒ½ä½“å¯¹è¯...</div>';
            section.style.display = 'block';
            
            const data = await makeRequest('/api/recommendation/start', { method: 'POST' });
            
            if (data.error) {
                content.innerHTML = `<div class="error">å¯åŠ¨å¤±è´¥: ${data.error}</div>`;
                return;
            }
            
            agentSessionActive = true;
            
            let html = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>æ™ºèƒ½ä½“ï¼š</strong>${data.message || 'ä¼šè¯å·²å¯åŠ¨'}
                </div>
            `;
            
            if (data.recommendations && data.recommendations.length > 0) {
                html += '<div style="margin: 15px 0;"><strong>æ¨èä¹¦ç±ï¼š</strong></div>';
                data.recommendations.forEach((book, index) => {
                    html += `
                        <div style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 6px;">
                            ${index + 1}. ã€Š${book.title}ã€‹- ${book.author}
                            <br><small style="color: #666;">${book.reason || book.description}</small>
                        </div>
                    `;
                });
            }
            
            content.innerHTML = html;
        }

        async function sendMessage() {
            if (!agentSessionActive) {
                alert('è¯·å…ˆå¯åŠ¨æ™ºèƒ½ä½“å¯¹è¯');
                return;
            }
            
            const messageInput = document.getElementById('userMessage');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            const content = document.getElementById('agentContent');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            content.innerHTML += `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: right;">
                    <strong>ä½ ï¼š</strong>${message}
                </div>
            `;
            
            messageInput.value = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            content.innerHTML += '<div class="loading">æ™ºèƒ½ä½“æ­£åœ¨æ€è€ƒ...</div>';
            
            const data = await makeRequest('/api/recommendation/chat', {
                method: 'POST',
                body: JSON.stringify({ message: message })
            });
            
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingDiv = content.querySelector('.loading');
            if (loadingDiv) loadingDiv.remove();
            
            if (data.error) {
                content.innerHTML += `<div class="error">å¯¹è¯å¤±è´¥: ${data.error}</div>`;
                return;
            }
            
            // æ·»åŠ æ™ºèƒ½ä½“å›å¤
            let replyHtml = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>æ™ºèƒ½ä½“ï¼š</strong>${data.message || 'æ”¶åˆ°ä½ çš„æ¶ˆæ¯'}
                </div>
            `;
            
            if (data.recommendations && data.recommendations.length > 0) {
                replyHtml += '<div style="margin: 15px 0;"><strong>æ–°æ¨èï¼š</strong></div>';
                data.recommendations.forEach((book, index) => {
                    replyHtml += `
                        <div style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 6px;">
                            ${index + 1}. ã€Š${book.title}ã€‹- ${book.author}
                            <br><small style="color: #666;">${book.reason || book.description}</small>
                        </div>
                    `;
                });
            }
            
            content.innerHTML += replyHtml;
            content.scrollTop = content.scrollHeight;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è·å–ç”¨æˆ·ç”»åƒ
        window.addEventListener('load', () => {
            console.log('å¢å¼ºç‰ˆæ¨èç³»ç»Ÿæµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>
