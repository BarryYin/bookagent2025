<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¹¦æ¶ - FogSight</title>
    <link rel="stylesheet" href="/static/style.css?v={{ time }}">
    <link rel="icon" href="/static/favicon.png?v={{ time }}" type="image/png">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="nav-left">
            <a href="/" class="nav-link">
                <img src="/static/logo.png?v={{ time }}" alt="FogSight" class="logo">
            </a>
            <a href="/library" class="nav-link">å›¾ä¹¦é¦†</a>
            <a href="/bookshelf" class="nav-link active">ä¸ªäººä¹¦æ¶</a>
        </div>
        <div class="nav-right">
            <div class="user-section" style="display: none;">
                <span class="username-display"></span>
                <button class="logout-button" onclick="logout()">ç™»å‡º</button>
            </div>
            <div class="auth-buttons">
                <a href="/login" class="auth-link login-link">ç™»å½•</a>
                <a href="/register" class="auth-link register-link">æ³¨å†Œ</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="library-page">
        <div class="library-header">
            <div class="header-content">
                <a href="/" class="back-link">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    è¿”å›é¦–é¡µ
                </a>
                <div class="library-title">
                    <h1>æˆ‘çš„ä¹¦æ¶</h1>
                    <p>ç®¡ç†æ‚¨ç”Ÿæˆçš„æ‰€æœ‰PPT</p>
                </div>
                <button class="refresh-btn" onclick="loadUserPPTs()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.914L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.914L3 16"/>
                    </svg>
                    åˆ·æ–°
                </button>
            </div>
        </div>

        <div class="library-main">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="library-stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-ppts">0</div>
                    <div class="stat-label">æ€»PPTæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-categories">0</div>
                    <div class="stat-label">åˆ†ç±»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="recent-ppts">0</div>
                    <div class="stat-label">æœ¬æœˆæ–°å¢</div>
                </div>
            </div>

            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="library-filters">
                <div class="filter-group">
                    <label for="category-filter">åˆ†ç±»ç­›é€‰</label>
                    <select id="category-filter" class="filter-select" onchange="filterPPTs()">
                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search-input">æœç´¢</label>
                    <input type="text" id="search-input" class="filter-input" placeholder="æœç´¢PPTæ ‡é¢˜æˆ–ä½œè€…..." onkeyup="searchPPTs()">
                </div>
                <div class="filter-group">
                    <button class="clear-filters-btn" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>

            <!-- PPTåˆ—è¡¨ -->
            <div class="ppt-library-grid" id="ppt-grid">
                <!-- PPTå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination-container" id="pagination" style="display: none;">
                <div class="pagination-info">
                    <span id="pagination-text">æ˜¾ç¤º 0-0 æ¡ï¼Œå…± 0 æ¡</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)" disabled>ä¸Šä¸€é¡µ</button>
                    <div class="page-numbers" id="page-numbers"></div>
                    <button class="pagination-btn" id="next-btn" onclick="changePage(1)" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-library" id="empty-state" style="display: none;">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                <h3>æ‚¨çš„ä¹¦æ¶è¿˜æ˜¯ç©ºçš„</h3>
                <p>å¼€å§‹ç”Ÿæˆæ‚¨çš„ç¬¬ä¸€ä¸ªPPTå§ï¼</p>
                <a href="/" class="create-first-btn">ç«‹å³ç”Ÿæˆ</a>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading-placeholder" id="loading-state">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ‚¨çš„PPT...</p>
            </div>
        </div>
    </div>


    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {
            category_id: '',
            search: ''
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadUserPPTs();
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const data = await response.json();
                    showUserSection(data.user);
                } else {
                    showAuthButtons();
                    // å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                showAuthButtons();
                window.location.href = '/login';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserSection(user) {
            document.querySelector('.user-section').style.display = 'flex';
            document.querySelector('.auth-buttons').style.display = 'none';
            document.querySelector('.username-display').textContent = user.username;
        }

        // æ˜¾ç¤ºè®¤è¯æŒ‰é’®
        function showAuthButtons() {
            document.querySelector('.user-section').style.display = 'none';
            document.querySelector('.auth-buttons').style.display = 'flex';
        }

        // ç™»å‡º
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·PPTåˆ—è¡¨
        async function loadUserPPTs() {
            const loadingState = document.getElementById('loading-state');
            const pptGrid = document.getElementById('ppt-grid');
            const emptyState = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');

            loadingState.style.display = 'flex';
            pptGrid.style.display = 'none';
            emptyState.style.display = 'none';
            pagination.style.display = 'none';

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 12,
                    ...currentFilters
                });

                const response = await fetch(`/api/user-ppts?${params}`);
                const data = await response.json();

                if (response.ok) {
                    displayPPTs(data.ppts, data.pagination);
                    updateStats(data.ppts);
                } else {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½PPTå¤±è´¥:', error);
                showError('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                loadingState.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºPPTåˆ—è¡¨
        function displayPPTs(ppts, pagination) {
            const pptGrid = document.getElementById('ppt-grid');
            const emptyState = document.getElementById('empty-state');
            const paginationContainer = document.getElementById('pagination');

            if (ppts.length === 0) {
                pptGrid.style.display = 'none';
                emptyState.style.display = 'flex';
                paginationContainer.style.display = 'none';
                return;
            }

            pptGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            paginationContainer.style.display = 'flex';

            pptGrid.innerHTML = ppts.map(ppt => `
                <div class="library-ppt-card">
                    <div class="library-card-preview ${ppt.cover_url ? 'book-cover-preview' : ''}">
                        ${ppt.cover_url ? 
                            (ppt.cover_url.startsWith('gradient:') ? 
                                `<div class="gradient-cover" style="background: ${ppt.cover_url.replace('gradient:', '')}">
                                    <div class="gradient-cover-content">
                                        <div class="gradient-cover-icon">ğŸ“š</div>
                                        <div class="gradient-cover-title">${ppt.title}</div>
                                        <div class="gradient-cover-subtitle">ä¹¦ç±å°é¢</div>
                                    </div>
                                </div>` :
                                `<img src="${ppt.cover_url}" alt="${ppt.title}" class="book-cover-image">`
                            ) :
                            `<div class="gradient-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="gradient-cover-content">
                                    <div class="gradient-cover-icon">ğŸ“š</div>
                                    <div class="gradient-cover-title">${ppt.title}</div>
                                    <div class="gradient-cover-subtitle">ä¹¦ç±å°é¢</div>
                                </div>
                            </div>`
                        }
                    </div>
                    <div class="library-card-info">
                        <h3 class="library-card-title">${ppt.title}</h3>
                        <div class="library-card-meta">
                            <span class="author">${ppt.author || 'æœªçŸ¥ä½œè€…'}</span>
                            ${ppt.category_name ? 
                                `<span class="category-badge" style="background-color: ${ppt.category_color}">
                                    <span class="category-icon">${ppt.category_icon}</span>
                                    <span class="category-name">${ppt.category_name}</span>
                                </span>` : ''
                            }
                            <span class="book-type-badge ${ppt.book_type === 'generated' ? 'generated' : 'added'}">
                                ${ppt.book_type === 'generated' ? 'ğŸ¨ ç”Ÿæˆçš„' : 'ğŸ“š æ·»åŠ çš„'}
                            </span>
                        </div>
                    </div>
                    <div class="library-card-actions">
                        <a href="${ppt.html_url}" target="_blank" class="library-action-btn primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            æŸ¥çœ‹
                        </a>
                        <a href="${ppt.preview_url}" target="_blank" class="library-action-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            é¢„è§ˆ
                        </a>
                        <button class="library-action-btn delete-btn" onclick="deletePPT('${ppt.session_id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                            </svg>
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');

            updatePagination(pagination);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(ppts) {
            const categories = new Set(ppts.map(ppt => ppt.category_id).filter(Boolean));
            const thisMonth = new Date().getMonth();
            const recentPPTs = ppts.filter(ppt => {
                const pptDate = new Date(ppt.created_at);
                return pptDate.getMonth() === thisMonth;
            }).length;

            document.getElementById('total-ppts').textContent = ppts.length;
            document.getElementById('total-categories').textContent = categories.size;
            document.getElementById('recent-ppts').textContent = recentPPTs;
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(pagination) {
            currentPage = pagination.current_page;
            totalPages = pagination.total_pages;

            document.getElementById('pagination-text').textContent = 
                `æ˜¾ç¤º ${(currentPage - 1) * pagination.per_page + 1}-${Math.min(currentPage * pagination.per_page, pagination.total_count)} æ¡ï¼Œå…± ${pagination.total_count} æ¡`;

            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;

            const pageNumbers = document.getElementById('page-numbers');
            pageNumbers.innerHTML = '';

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadUserPPTs();
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(page) {
            currentPage = page;
            loadUserPPTs();
        }

        // ç­›é€‰PPT
        function filterPPTs() {
            currentFilters.category_id = document.getElementById('category-filter').value;
            currentPage = 1;
            loadUserPPTs();
        }

        // æœç´¢PPT
        function searchPPTs() {
            currentFilters.search = document.getElementById('search-input').value;
            currentPage = 1;
            loadUserPPTs();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('category-filter').value = '';
            document.getElementById('search-input').value = '';
            currentFilters = { category_id: '', search: '' };
            currentPage = 1;
            loadUserPPTs();
        }

        // åˆ é™¤PPT
        async function deletePPT(sessionId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªPPTå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/user-ppts/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess('PPTåˆ é™¤æˆåŠŸ');
                    loadUserPPTs();
                } else {
                    const data = await response.json();
                    throw new Error(data.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤PPTå¤±è´¥:', error);
                showError('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            // å¯ä»¥æ·»åŠ ä¸€ä¸ªç®€å•çš„æç¤ºç»„ä»¶
            alert(message);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            // å¯ä»¥æ·»åŠ ä¸€ä¸ªç®€å•çš„æç¤ºç»„ä»¶
            alert(message);
        }
    </script>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?694776aeda6a0ddf5ad8a4c70694efce";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html> 