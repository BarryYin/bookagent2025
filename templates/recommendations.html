<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªæ€§åŒ–æ¨è - FogSight</title>
    <link rel="stylesheet" href="/static/style.css?v={{ time }}">
    <link rel="icon" href="/static/favicon.png?v={{ time }}" type="image/png">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="/static/logo.png?v={{ time }}" alt="FogSight" class="logo-img">
                <span class="logo-text">FogSight</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">é¦–é¡µ</a>
                <a href="/library" class="nav-link">å›¾ä¹¦é¦†</a>
                <a href="/bookshelf" class="nav-link" id="bookshelf-link" style="display: none;">ä¸ªäººä¹¦æ¶</a>
                <a href="/recommendations" class="nav-link active">æ¨è</a>
                <div class="auth-buttons" id="auth-buttons">
                    <button class="btn btn-primary" onclick="showAuthModal()">ç™»å½•</button>
                </div>
                <div class="user-menu" id="user-menu" style="display: none;">
                    <span class="username" id="username"></span>
                    <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="page-header">
                <h1 class="page-title">ğŸ¯ ä¸ªæ€§åŒ–æ¨è</h1>
                <p class="page-subtitle">åŸºäºæ‚¨çš„é˜…è¯»åå¥½ï¼Œä¸ºæ‚¨æ¨èæœ€åˆé€‚çš„ä¹¦ç±</p>
            </div>

            <!-- ç”¨æˆ·åå¥½åˆ†æ -->
            <div class="preferences-section" id="preferences-section" style="display: none;">
                <h2 class="section-title">ğŸ“Š æ‚¨çš„é˜…è¯»åå¥½</h2>
                <div class="preferences-chart" id="preferences-chart">
                    <!-- åå¥½å›¾è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ¨èä¹¦ç± -->
            <div class="recommendations-section">
                <h2 class="section-title">ğŸ“š ä¸ºæ‚¨æ¨è</h2>
                <div class="recommendations-grid" id="recommendations-grid">
                    <!-- æ¨èä¹¦ç±å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–æ¨è...</p>
                </div>
                <div class="no-recommendations" id="no-recommendations" style="display: none;">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“–</div>
                        <h3>æš‚æ— æ¨è</h3>
                        <p>å¼€å§‹ç”Ÿæˆæ‚¨çš„ç¬¬ä¸€æœ¬ä¹¦ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–æ¨è</p>
                        <a href="/" class="btn btn-primary">å»ç”Ÿæˆä¹¦ç±</a>
                    </div>
                </div>
            </div>

            <!-- åˆ†ç±»æ¨è -->
            <div class="category-recommendations" id="category-recommendations" style="display: none;">
                <h2 class="section-title">ğŸ·ï¸ æŒ‰åˆ†ç±»æ¨è</h2>
                <div class="category-tabs" id="category-tabs">
                    <!-- åˆ†ç±»æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="category-books" id="category-books">
                    <!-- åˆ†ç±»ä¹¦ç±å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </main>

    <!-- è®¤è¯æ¨¡æ€æ¡† -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h3>ç™»å½•/æ³¨å†Œ</h3>
                <button class="close-btn" onclick="hideAuthModal()">&times;</button>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>
            <div class="auth-form" id="login-form">
                <input type="text" id="login-username" placeholder="ç”¨æˆ·å" required>
                <input type="password" id="login-password" placeholder="å¯†ç " required>
                <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
            </div>
            <div class="auth-form" id="register-form" style="display: none;">
                <input type="text" id="register-username" placeholder="ç”¨æˆ·å" required>
                <input type="email" id="register-email" placeholder="é‚®ç®±" required>
                <input type="password" id="register-password" placeholder="å¯†ç " required>
                <button class="btn btn-primary" onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let userPreferences = {};
        let recommendations = [];
        let categoryBooks = {};

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼Œé¿å…æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            checkUserAuth();
        });

        // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
        async function checkUserAuth() {
            const loadingSpinner = document.getElementById('loading-spinner');
            const noRecommendations = document.getElementById('no-recommendations');
            
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showUserMenu();
                    loadUserPreferences();
                    loadRecommendations(); // ç”¨æˆ·ç™»å½•ååŠ è½½æ¨è
                } else {
                    showAuthButtons();
                    // ç”¨æˆ·æœªç™»å½•ï¼Œç«‹å³æ˜¾ç¤ºç™»å½•æç¤º
                    loadingSpinner.style.display = 'none';
                    noRecommendations.style.display = 'block';
                    const emptyState = noRecommendations.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.innerHTML = `
                            <div class="empty-icon">ğŸ”</div>
                            <h3>è¯·å…ˆç™»å½•</h3>
                            <p>ç™»å½•åå³å¯æŸ¥çœ‹ä¸ªæ€§åŒ–æ¨è</p>
                            <button class="btn btn-primary" onclick="showAuthModal()">ç«‹å³ç™»å½•</button>
                        `;
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                showAuthButtons();
                // ç”¨æˆ·æœªç™»å½•ï¼Œç«‹å³æ˜¾ç¤ºç™»å½•æç¤º
                loadingSpinner.style.display = 'none';
                noRecommendations.style.display = 'block';
                const emptyState = noRecommendations.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.innerHTML = `
                        <div class="empty-icon">ğŸ”</div>
                        <h3>è¯·å…ˆç™»å½•</h3>
                        <p>ç™»å½•åå³å¯æŸ¥çœ‹ä¸ªæ€§åŒ–æ¨è</p>
                        <button class="btn btn-primary" onclick="showAuthModal()">ç«‹å³ç™»å½•</button>
                    `;
                }
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·èœå•
        function showUserMenu() {
            document.getElementById('auth-buttons').style.display = 'none';
            document.getElementById('user-menu').style.display = 'flex';
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('bookshelf-link').style.display = 'inline';
        }

        // æ˜¾ç¤ºè®¤è¯æŒ‰é’®
        function showAuthButtons() {
            document.getElementById('auth-buttons').style.display = 'flex';
            document.getElementById('user-menu').style.display = 'none';
            document.getElementById('bookshelf-link').style.display = 'none';
        }

        // åŠ è½½æ¨è
        async function loadRecommendations() {
            const loadingSpinner = document.getElementById('loading-spinner');
            const noRecommendations = document.getElementById('no-recommendations');
            const recommendationsGrid = document.getElementById('recommendations-grid');

            // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
            if (!currentUser) {
                loadingSpinner.style.display = 'none';
                noRecommendations.style.display = 'block';
                // ä¿®æ”¹ç©ºçŠ¶æ€çš„å†…å®¹ä¸ºç™»å½•æç¤º
                const emptyState = noRecommendations.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.innerHTML = `
                        <div class="empty-icon">ğŸ”</div>
                        <h3>è¯·å…ˆç™»å½•</h3>
                        <p>ç™»å½•åå³å¯æŸ¥çœ‹ä¸ªæ€§åŒ–æ¨è</p>
                        <button class="btn btn-primary" onclick="showAuthModal()">ç«‹å³ç™»å½•</button>
                    `;
                }
                return;
            }

            try {
                const response = await fetch('/api/recommendations?limit=12');
                if (response.ok) {
                    const data = await response.json();
                    recommendations = data.recommendations || [];
                    
                    if (recommendations.length > 0) {
                        renderRecommendations(recommendations);
                        loadCategoryRecommendations();
                        // å»¶è¿Ÿæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                        setTimeout(() => {
                            updateAllBookshelfButtons();
                        }, 500);
                    } else {
                        loadingSpinner.style.display = 'none';
                        noRecommendations.style.display = 'block';
                        // æ¢å¤åŸå§‹çš„ç©ºçŠ¶æ€å†…å®¹
                        const emptyState = noRecommendations.querySelector('.empty-state');
                        if (emptyState) {
                            emptyState.innerHTML = `
                                <div class="empty-icon">ğŸ“–</div>
                                <h3>æš‚æ— æ¨è</h3>
                                <p>å¼€å§‹ç”Ÿæˆæ‚¨çš„ç¬¬ä¸€æœ¬ä¹¦ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–æ¨è</p>
                                <a href="/" class="btn btn-primary">å»ç”Ÿæˆä¹¦ç±</a>
                            `;
                        }
                    }
                } else {
                    throw new Error('è·å–æ¨èå¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ¨èå¤±è´¥:', error);
                loadingSpinner.style.display = 'none';
                noRecommendations.style.display = 'block';
            }
        }

        // æ¸²æŸ“æ¨èä¹¦ç±
        function renderRecommendations(books) {
            const grid = document.getElementById('recommendations-grid');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            loadingSpinner.style.display = 'none';
            
            grid.innerHTML = books.map(book => `
                <div class="library-card recommendation-card" data-session-id="${book.session_id}">
                    <div class="library-card-header">
                        <div class="library-card-category">
                            <span class="category-badge" style="background-color: ${book.category_color || '#E74C3C'}">
                                ${book.category_icon || 'ğŸ“–'} ${book.category_name || 'æœªåˆ†ç±»'}
                            </span>
                        </div>
                        <div class="library-card-actions">
                            <button class="action-btn" onclick="viewBook('${book.session_id}')" title="æŸ¥çœ‹è¯¦æƒ…">
                                ğŸ‘ï¸
                            </button>
                            <button class="action-btn add-to-bookshelf-btn" onclick="addToBookshelf('${book.title}', '${book.author || ''}', '${book.cover_url || ''}', '${book.category_id || ''}', '${book.category_name || ''}', '${book.category_color || ''}', '${book.category_icon || ''}', 'recommendation', '${book.session_id}')" title="æ·»åŠ åˆ°ä¹¦æ¶">
                                ğŸ“š
                            </button>
                        </div>
                    </div>
                    <div class="library-card-preview ${book.cover_url ? 'book-cover-preview' : ''}">
                        ${book.cover_url ? 
                            (book.cover_url.startsWith('gradient:') ? 
                                `<div class="gradient-cover" style="background: ${book.cover_url.replace('gradient:', '')}">
                                    <div class="gradient-cover-content">
                                        <div class="gradient-cover-icon">ğŸ“–</div>
                                        <div class="gradient-cover-title">${book.title}</div>
                                    </div>
                                </div>` :
                                `<img src="${book.cover_url}" alt="${book.title}" class="book-cover-image">`
                            ) :
                            `<div class="fallback-cover">
                                <div class="fallback-icon">ğŸ“–</div>
                                <div class="fallback-title">${book.title}</div>
                            </div>`
                        }
                    </div>
                    <div class="library-card-content">
                        <h3 class="library-card-title">${book.title}</h3>
                        <p class="library-card-author">${book.author || 'æœªçŸ¥ä½œè€…'}</p>
                        <div class="library-card-meta">
                            <span class="meta-item">
                                <span class="meta-icon">ğŸ”¥</span>
                                <span class="meta-text">çƒ­é—¨æ¨è</span>
                            </span>
                            <span class="meta-item">
                                <span class="meta-icon">ğŸ“…</span>
                                <span class="meta-text">${formatDate(book.created_at)}</span>
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ ä¹¦ç±åˆ°ä¹¦æ¶
        async function addToBookshelf(title, author, cover_url, category_id, category_name, category_color, category_icon, source_type, source_id) {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            try {
                const response = await fetch('/api/add-book-to-bookshelf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        author: author,
                        cover_url: cover_url,
                        category_id: category_id,
                        category_name: category_name,
                        category_color: category_color,
                        category_icon: category_icon,
                        source_type: source_type,
                        source_id: source_id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('âœ… ' + result.message, 'success');
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateAddToBookshelfButton(title, author, true);
                } else {
                    showMessage('âŒ ' + result.message, 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ ä¹¦ç±åˆ°ä¹¦æ¶å¤±è´¥:', error);
                showMessage('âŒ æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // æ£€æŸ¥ä¹¦ç±æ˜¯å¦å·²åœ¨ä¹¦æ¶ä¸­
        async function checkBookInBookshelf(title, author) {
            if (!currentUser) return false;
            
            try {
                const response = await fetch(`/api/check-book-in-bookshelf?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author || '')}`);
                if (response.ok) {
                    const result = await response.json();
                    return result.in_bookshelf;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ä¹¦ç±æ˜¯å¦åœ¨ä¹¦æ¶ä¸­å¤±è´¥:', error);
            }
            return false;
        }

        // æ›´æ–°æ·»åŠ åˆ°ä¹¦æ¶æŒ‰é’®çŠ¶æ€
        function updateAddToBookshelfButton(title, author, added) {
            const buttons = document.querySelectorAll('.add-to-bookshelf-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`'${title}'`) && onclick.includes(`'${author}'`)) {
                    if (added) {
                        btn.innerHTML = 'âœ…';
                        btn.title = 'å·²æ·»åŠ åˆ°ä¹¦æ¶';
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                    } else {
                        btn.innerHTML = 'ğŸ“š';
                        btn.title = 'æ·»åŠ åˆ°ä¹¦æ¶';
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                }
            });
        }

        // æ£€æŸ¥å¹¶æ›´æ–°æ‰€æœ‰æŒ‰é’®çŠ¶æ€
        async function updateAllBookshelfButtons() {
            if (!currentUser) return;
            
            const buttons = document.querySelectorAll('.add-to-bookshelf-btn');
            for (let btn of buttons) {
                const onclick = btn.getAttribute('onclick');
                if (onclick) {
                    // ä»onclickä¸­æå–titleå’Œauthor
                    const titleMatch = onclick.match(/'([^']+)'/);
                    const authorMatch = onclick.match(/'([^']+)', '([^']+)'/);
                    
                    if (titleMatch) {
                        const title = titleMatch[1];
                        const author = authorMatch ? authorMatch[2] : '';
                        
                        const inBookshelf = await checkBookInBookshelf(title, author);
                        updateAddToBookshelfButton(title, author, inBookshelf);
                    }
                }
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#27AE60';
            } else if (type === 'error') {
                messageDiv.style.backgroundColor = '#E74C3C';
            } else {
                messageDiv.style.backgroundColor = '#3498DB';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
        
        // åŠ è½½ç”¨æˆ·åå¥½
        async function loadUserPreferences() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('/api/user-preferences');
                if (response.ok) {
                    const data = await response.json();
                    userPreferences = data.preferences || {};
                    renderUserPreferences();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åå¥½å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åå¥½
        function renderUserPreferences() {
            const preferencesSection = document.getElementById('preferences-section');
            const preferencesChart = document.getElementById('preferences-chart');
            
            if (Object.keys(userPreferences).length === 0) {
                preferencesSection.style.display = 'none';
                return;
            }
            
            preferencesSection.style.display = 'block';
            
            const totalBooks = Object.values(userPreferences).reduce((sum, count) => sum + count, 0);
            
            preferencesChart.innerHTML = Object.entries(userPreferences).map(([category, count]) => {
                const percentage = ((count / totalBooks) * 100).toFixed(1);
                return `
                    <div class="preference-item">
                        <div class="preference-category">${category}</div>
                        <div class="preference-bar">
                            <div class="preference-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="preference-stats">
                            <span class="preference-count">${count} æœ¬</span>
                            <span class="preference-percentage">${percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½åˆ†ç±»æ¨è
        async function loadCategoryRecommendations() {
            if (!currentUser) return;
            
            const categories = [...new Set(recommendations.map(book => book.category_name))];
            const categoryRecommendations = document.getElementById('category-recommendations');
            const categoryTabs = document.getElementById('category-tabs');
            
            if (categories.length <= 1) {
                categoryRecommendations.style.display = 'none';
                return;
            }
            
            categoryRecommendations.style.display = 'block';
            
            // ç”Ÿæˆåˆ†ç±»æ ‡ç­¾
            categoryTabs.innerHTML = categories.map((category, index) => `
                <button class="category-tab ${index === 0 ? 'active' : ''}" 
                        onclick="switchCategoryTab('${category}')">
                    ${category}
                </button>
            `).join('');
            
            // åŠ è½½ç¬¬ä¸€ä¸ªåˆ†ç±»çš„ä¹¦ç±
            if (categories.length > 0) {
                await loadCategoryBooks(categories[0]);
            }
        }

        // åˆ‡æ¢åˆ†ç±»æ ‡ç­¾
        async function switchCategoryTab(category) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åŠ è½½è¯¥åˆ†ç±»çš„ä¹¦ç±
            await loadCategoryBooks(category);
        }

        // åŠ è½½åˆ†ç±»ä¹¦ç±
        async function loadCategoryBooks(category) {
            if (categoryBooks[category]) {
                renderCategoryBooks(categoryBooks[category]);
                return;
            }
            
            try {
                const response = await fetch(`/api/popular-books/${encodeURIComponent(category)}?limit=8`);
                if (response.ok) {
                    const data = await response.json();
                    categoryBooks[category] = data.books || [];
                    renderCategoryBooks(categoryBooks[category]);
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»ä¹¦ç±å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“åˆ†ç±»ä¹¦ç±
        function renderCategoryBooks(books) {
            const categoryBooksContainer = document.getElementById('category-books');
            
            if (books.length === 0) {
                categoryBooksContainer.innerHTML = `
                    <div class="empty-category">
                        <p>è¯¥åˆ†ç±»æš‚æ— æ›´å¤šæ¨è</p>
                    </div>
                `;
                return;
            }
            
            categoryBooksContainer.innerHTML = books.map(book => `
                <div class="library-card category-book-card" data-session-id="${book.session_id}">
                    <div class="library-card-preview ${book.cover_url ? 'book-cover-preview' : ''}">
                        ${book.cover_url ? 
                            (book.cover_url.startsWith('gradient:') ? 
                                `<div class="gradient-cover" style="background: ${book.cover_url.replace('gradient:', '')}">
                                    <div class="gradient-cover-content">
                                        <div class="gradient-cover-icon">ğŸ“–</div>
                                        <div class="gradient-cover-title">${book.title}</div>
                                    </div>
                                </div>` :
                                `<img src="${book.cover_url}" alt="${book.title}" class="book-cover-image">`
                            ) :
                            `<div class="fallback-cover">
                                <div class="fallback-icon">ğŸ“–</div>
                                <div class="fallback-title">${book.title}</div>
                            </div>`
                        }
                    </div>
                    <div class="library-card-content">
                        <h3 class="library-card-title">${book.title}</h3>
                        <p class="library-card-author">${book.author || 'æœªçŸ¥ä½œè€…'}</p>
                        <div class="library-card-meta">
                            <span class="meta-item">
                                <span class="meta-icon">ğŸ”¥</span>
                                <span class="meta-text">çƒ­åº¦ ${book.popularity_score || 0}</span>
                            </span>
                        </div>
                        <div class="library-card-actions">
                            <button class="library-action-btn primary" onclick="viewBook('${book.session_id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15,3 21,3 21,9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                æŸ¥çœ‹PPT
                            </button>
                            <button class="library-action-btn add-to-bookshelf-btn" onclick="addToBookshelf('${book.title}', '${book.author || ''}', '${book.cover_url || ''}', '${book.category_id || ''}', '${book.category_name || ''}', '${book.category_color || ''}', '${book.category_icon || ''}', 'recommendations', '${book.session_id}')" title="æ·»åŠ åˆ°ä¹¦æ¶">
                                ğŸ“š
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // å»¶è¿Ÿæ›´æ–°æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                updateAllBookshelfButtons();
            }, 100);
        }

        // æŸ¥çœ‹ä¹¦ç±è¯¦æƒ…
        function viewBook(sessionId) {
            window.open(`/outputs/${sessionId}/presentation.html`, '_blank');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // è®¤è¯ç›¸å…³å‡½æ•°
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        function switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                if (response.ok) {
                    hideAuthModal();
                    checkUserAuth(); // è¿™ä¼šé‡æ–°åŠ è½½æ¨è
                } else {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        async function register() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, email, password})
                });
                
                if (response.ok) {
                    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                    switchAuthTab('login');
                } else {
                    alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯');
                }
            } catch (error) {
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', {method: 'POST'});
                currentUser = null;
                showAuthButtons();
                location.reload();
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('auth-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAuthModal();
            }
        });

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideAuthModal();
            }
        });
    </script>
</body>
</html> 