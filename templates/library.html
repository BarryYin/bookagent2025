<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ä¹¦é¦† - PPTä½œå“é›†</title>
    <link rel="stylesheet" href="/static/style.css?v={{ time }}">
    <link rel="icon" href="/static/favicon.png?v={{ time }}" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="library-page">
    <header class="library-header">
        <div class="header-content">
            <div class="header-left">
                <a href="/" class="back-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m12 19-7-7 7-7"/>
                        <path d="M19 12H5"/>
                    </svg>
                    è¿”å›é¦–é¡µ
                </a>
            </div>
            <h1 class="library-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                å›¾ä¹¦é¦†
            </h1>
            <div class="header-right">
                <button id="refresh-library" class="refresh-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    åˆ·æ–°
                </button>
            </div>
        </div>
    </header>

    <main class="library-main">
        <div class="library-stats" id="library-stats">
            <div class="stat-item">
                <span class="stat-number" id="total-ppts">-</span>
                <span class="stat-label">æ€»ä½œå“æ•°</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="recent-ppts">-</span>
                <span class="stat-label">æœ¬å‘¨æ–°å¢</span>
            </div>
        </div>

        <!-- ç­›é€‰å’Œæœç´¢åŒºåŸŸ -->
        <div class="library-filters">
            <div class="filter-group">
                <label for="category-filter">åˆ†ç±»ç­›é€‰:</label>
                <select id="category-filter" class="filter-select">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="literature">ğŸ“– æ–‡å­¦ç±»</option>
                    <option value="efficiency">âš¡ æ•ˆç‡æå‡ç±»</option>
                    <option value="fiction">ğŸ”® è™šæ„ç±»</option>
                    <option value="biography">ğŸ‘¤ è‡ªä¼ ç±»</option>
                    <option value="textbook">ğŸ“š æ•™æç±»</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="search-input">æœç´¢:</label>
                <input type="text" id="search-input" class="filter-input" placeholder="è¾“å…¥ä¹¦åæˆ–å…³é”®è¯...">
            </div>
            <button id="clear-filters" class="clear-filters-btn">æ¸…é™¤ç­›é€‰</button>
        </div>

        <div class="library-content">
            <div class="ppt-library-grid" id="ppt-library-grid">
                <div class="loading-placeholder">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½PPTä½œå“...</p>
                </div>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="pagination-container" id="pagination-container" style="display: none;">
                <div class="pagination-info">
                    <span id="pagination-info">æ˜¾ç¤º 1-10 æ¡ï¼Œå…± 0 æ¡</span>
                </div>
                <div class="pagination-controls">
                    <button id="prev-page" class="pagination-btn" disabled>ä¸Šä¸€é¡µ</button>
                    <div class="page-numbers" id="page-numbers"></div>
                    <button id="next-page" class="pagination-btn">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ä¸åŠ è½½å…¨å±€script.jsï¼Œé¿å…å‡½æ•°å†²çª -->
    <script src="/static/fix_ppt_gallery.js?v={{ time }}"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let currentCategory = '';
        let currentSearch = '';
        let currentLimit = 12;

        // å›¾ä¹¦é¦†é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadLibraryPagePPTs();
            
            // åˆ·æ–°æŒ‰é’®äº‹ä»¶
            document.getElementById('refresh-library').addEventListener('click', function() {
                loadLibraryPagePPTs();
            });
            
            // ç­›é€‰å’Œåˆ†é¡µäº‹ä»¶
            setupLibraryFiltersAndPagination();
        });

        async function loadLibraryPagePPTs(page = 1, category = '', search = '') {
            const grid = document.getElementById('ppt-library-grid');
            const totalStat = document.getElementById('total-ppts');
            const recentStat = document.getElementById('recent-ppts');
            
            try {
                grid.innerHTML = '<div class="loading-placeholder"><div class="loading-spinner"></div><p>æ­£åœ¨åŠ è½½PPTä½œå“...</p></div>';
                
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams({
                    limit: currentLimit,
                    page: page,
                    ...(category && { category_id: category }),
                    ...(search && { search: search })
                });
                
                const response = await fetch(`/api/generated-ppts?${params}`);
                const data = await response.json();
                
                if (data.ppts && data.ppts.length > 0) {
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    totalStat.textContent = data.pagination ? data.pagination.total_count : data.ppts.length;
                    
                    // è®¡ç®—æœ¬å‘¨æ–°å¢ï¼ˆç®€å•å®ç°ï¼šæœ€è¿‘7å¤©ï¼‰
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    const recentCount = data.ppts.filter(ppt => {
                        const pptDate = new Date(ppt.created_time);
                        return pptDate > oneWeekAgo;
                    }).length;
                    recentStat.textContent = recentCount;
                    
                    // æ¸²æŸ“PPTç½‘æ ¼
                    renderLibraryPagePPTs(data.ppts);
                    
                    // æ¸²æŸ“åˆ†é¡µ
                    if (data.pagination) {
                        renderPagination(data.pagination);
                    }
                } else {
                    grid.innerHTML = `
                        <div class="empty-library">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                            <h3>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä½œå“</h3>
                            <p>å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</p>
                            <button onclick="clearLibraryFilters()" class="create-first-btn">æ¸…é™¤ç­›é€‰</button>
                        </div>
                    `;
                    totalStat.textContent = '0';
                    recentStat.textContent = '0';
                }
            } catch (error) {
                console.error('åŠ è½½PPTå¤±è´¥:', error);
                grid.innerHTML = `
                    <div class="error-library">
                        <p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                        <button onclick="loadLibraryPagePPTs()" class="retry-btn">é‡è¯•</button>
                    </div>
                `;
            }
        }

        function renderLibraryPagePPTs(ppts) {
            const grid = document.getElementById('ppt-library-grid');
            grid.innerHTML = '';
            
            ppts.forEach((ppt, index) => {
                const card = createLibraryPPTCard(ppt, index);
                grid.appendChild(card);
            });
        }

        function createLibraryPPTCard(ppt, index) {
            const card = document.createElement('div');
            card.className = 'library-ppt-card';
            card.style.animationDelay = `${index * 0.1}s`;
            
            // å¤„ç†å°é¢æ˜¾ç¤º
            let previewContent = '';
            if (ppt.cover_url && !ppt.cover_url.startsWith('gradient:')) {
                // ä½¿ç”¨çœŸå®ä¹¦ç±å°é¢
                previewContent = `
                    <div class="library-card-preview book-cover-preview">
                        <img src="${ppt.cover_url}" alt="${escapeHtml(ppt.title)}" class="book-cover-image" 
                             onerror="this.parentElement.innerHTML='<div class=\\'fallback-cover\\'><div class=\\'fallback-icon\\'>ğŸ“š</div><div class=\\'fallback-title\\'>${escapeHtml(ppt.title)}</div></div>'">
                    </div>
                `;
            } else {
                // ä½¿ç”¨æ¸å˜èƒŒæ™¯æˆ–é»˜è®¤æ ·å¼
                let background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                if (ppt.cover_url && ppt.cover_url.startsWith('gradient:')) {
                    background = ppt.cover_url.replace('gradient:', '');
                } else {
                    // å¤‡ç”¨æ¸å˜è‰²
                    const gradients = [
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                    ];
                    background = gradients[index % gradients.length];
                }

                const bookIcons = ['ğŸ“–', 'ğŸ“š', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“—', 'ğŸ“•'];
                const icon = bookIcons[index % bookIcons.length];

                previewContent = `
                    <div class="library-card-preview" style="background: ${background};">
                        <div class="preview-content">
                            <div class="preview-icon">${icon}</div>
                            <div class="preview-title">${escapeHtml(ppt.title)}</div>
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ åˆ†ç±»æ ‡ç­¾
            let categoryBadge = '';
            if (ppt.category_name && ppt.category_icon) {
                categoryBadge = `
                    <div class="category-badge" style="background-color: ${ppt.category_color || '#E74C3C'};">
                        <span class="category-icon">${ppt.category_icon}</span>
                        <span class="category-name">${ppt.category_name}</span>
                    </div>
                `;
            }

            card.innerHTML = `
                ${previewContent}
                <div class="library-card-info">
                    <h3 class="library-card-title">${escapeHtml(ppt.title)}</h3>
                    <div class="library-card-meta">
                        <span class="creation-time">${ppt.created_time}</span>
                        <span class="session-id">${ppt.session_id.substring(0, 8)}...</span>
                        ${categoryBadge}
                    </div>
                    <div class="library-card-actions">
                        <a href="${ppt.html_url}" target="_blank" class="library-action-btn primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15,3 21,3 21,9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            æŸ¥çœ‹PPT
                        </a>
                        <button class="library-action-btn" onclick="copyPPTLink('${ppt.html_url}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                            å¤åˆ¶é“¾æ¥
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function copyPPTLink(url) {
            const fullUrl = window.location.origin + url;
            navigator.clipboard.writeText(fullUrl).then(() => {
                // ç®€å•æç¤º
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"></polyline></svg>å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½
        function setupLibraryFiltersAndPagination() {
            const categoryFilter = document.getElementById('category-filter');
            const searchInput = document.getElementById('search-input');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');

            // åˆ†ç±»ç­›é€‰äº‹ä»¶
            categoryFilter.addEventListener('change', function() {
                currentCategory = this.value;
                currentPage = 1;
                loadLibraryPagePPTs(currentPage, currentCategory, currentSearch);
            });

            // æœç´¢äº‹ä»¶
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearch = this.value.trim();
                    currentPage = 1;
                    loadLibraryPagePPTs(currentPage, currentCategory, currentSearch);
                }, 500); // é˜²æŠ–å»¶è¿Ÿ
            });

            // æ¸…é™¤ç­›é€‰äº‹ä»¶
            clearFiltersBtn.addEventListener('click', clearLibraryFilters);

            // åˆ†é¡µäº‹ä»¶
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadLibraryPagePPTs(currentPage, currentCategory, currentSearch);
                }
            });

            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                loadLibraryPagePPTs(currentPage, currentCategory, currentSearch);
            });
        }

        function clearLibraryFilters() {
            currentCategory = '';
            currentSearch = '';
            currentPage = 1;
            
            document.getElementById('category-filter').value = '';
            document.getElementById('search-input').value = '';
            
            loadLibraryPagePPTs(currentPage, currentCategory, currentSearch);
        }

        function renderPagination(pagination) {
            const container = document.getElementById('pagination-container');
            const info = document.getElementById('pagination-info');
            const pageNumbers = document.getElementById('page-numbers');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            // æ˜¾ç¤ºåˆ†é¡µå®¹å™¨
            container.style.display = 'block';

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const start = (pagination.current_page - 1) * pagination.per_page + 1;
            const end = Math.min(start + pagination.per_page - 1, pagination.total_count);
            info.textContent = `æ˜¾ç¤º ${start}-${end} æ¡ï¼Œå…± ${pagination.total_count} æ¡`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            prevBtn.disabled = pagination.current_page <= 1;
            nextBtn.disabled = pagination.current_page >= pagination.total_pages;

            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbers.innerHTML = '';
            const maxPages = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªé¡µç 
            let startPage = Math.max(1, pagination.current_page - Math.floor(maxPages / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === pagination.current_page ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    loadLibraryPagePPTs(currentPage, currentCategory, currentSearch);
                });
                pageNumbers.appendChild(pageBtn);
            }
        }
    </script>
</body>

</html>