<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä¹¦ç±ä»‹ç»ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .generation-wizard {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .wizard-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .wizard-tab {
            flex: 1;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .wizard-tab.active {
            color: #007bff;
            background: white;
        }

        .wizard-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }

        .wizard-content {
            padding: 2rem;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        /* æ­¥éª¤1ï¼šä¹¦ç±ä¿¡æ¯ */
        .book-info-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* æ­¥éª¤2ï¼šæ–¹æ³•è®ºé€‰æ‹© */
        .methodology-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .methodology-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .methodology-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.15);
        }

        .methodology-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .methodology-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .methodology-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }

        .methodology-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .methodology-description {
            color: #6c757d;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .methodology-features {
            list-style: none;
        }

        .methodology-features li {
            padding: 0.25rem 0;
            color: #495057;
            position: relative;
            padding-left: 1.5rem;
        }

        .methodology-features li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }

        /* æ­¥éª¤3ï¼šé£æ ¼é…ç½® */
        .style-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .style-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .style-section h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .style-options {
            display: grid;
            gap: 1rem;
        }

        .style-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .style-option:hover {
            border-color: #007bff;
        }

        .style-option.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .style-option-icon {
            font-size: 1.5rem;
        }

        .style-option-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
            color: #2c3e50;
        }

        .style-option-info p {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* æŒ‰é’®æ ·å¼ */
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-outline {
            background: transparent;
            color: #007bff;
            border: 2px solid #007bff;
        }

        .btn-outline:hover {
            background: #007bff;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #6c757d;
            position: relative;
        }

        .progress-step.active {
            background: #007bff;
            color: white;
        }

        .progress-step.completed {
            background: #28a745;
            color: white;
        }

        .progress-line {
            width: 60px;
            height: 2px;
            background: #e9ecef;
        }

        .progress-line.completed {
            background: #28a745;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .methodology-grid {
                grid-template-columns: 1fr;
            }

            .style-config {
                grid-template-columns: 1fr;
            }

            .wizard-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .wizard-tabs {
                flex-direction: column;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wizard-step.active {
            animation: fadeInUp 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ™ºèƒ½ä¹¦ç±ä»‹ç»ç”Ÿæˆå™¨</h1>
            <p>èåˆå¤šç§ä¸“ä¸šä»‹ç»æ–¹æ³•è®ºï¼Œæ‰“é€ ä¸ªæ€§åŒ–çš„ä¹¦ç±æ¼”ç¤ºå†…å®¹</p>
        </div>

        <div class="generation-wizard">
            <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
            <div class="progress-indicator">
                <div class="progress-step active" data-step="1">1</div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">2</div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">3</div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="wizard-tabs">
                <button class="wizard-tab active" data-step="1">ğŸ“š ä¹¦ç±ä¿¡æ¯</button>
                <button class="wizard-tab" data-step="2">ğŸ­ ä»‹ç»æ–¹æ³•è®º</button>
                <button class="wizard-tab" data-step="3">ğŸ¨ é£æ ¼é…ç½®</button>
            </div>

            <div class="wizard-content">
                <!-- æ­¥éª¤1ï¼šä¹¦ç±ä¿¡æ¯ -->
                <div class="wizard-step active" data-step="1">
                    <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">ğŸ“š è¾“å…¥ä¹¦ç±åŸºæœ¬ä¿¡æ¯</h2>
                    <form class="book-info-form" id="bookInfoForm">
                        <div class="form-group">
                            <label for="bookTitle">ä¹¦ç±åç§° *</label>
                            <input type="text" id="bookTitle" required placeholder="ä¾‹å¦‚ï¼šç™¾å¹´å­¤ç‹¬">
                        </div>

                        <div class="form-group">
                            <label for="bookAuthor">ä½œè€…</label>
                            <input type="text" id="bookAuthor" placeholder="ä¾‹å¦‚ï¼šåŠ è¥¿äºšÂ·é©¬å°”å…‹æ–¯">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="bookCategory">ä¹¦ç±åˆ†ç±»</label>
                                <select id="bookCategory">
                                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                    <option value="æ–‡å­¦ç±»">æ–‡å­¦ç±»</option>
                                    <option value="å°è¯´">å°è¯´</option>
                                    <option value="æ•£æ–‡">æ•£æ–‡</option>
                                    <option value="è¯—æ­Œ">è¯—æ­Œ</option>
                                    <option value="ä¼ è®°">ä¼ è®°</option>
                                    <option value="è‡ªä¼ ">è‡ªä¼ </option>
                                    <option value="å›å¿†å½•">å›å¿†å½•</option>
                                    <option value="ç§‘å¹»">ç§‘å¹»</option>
                                    <option value="å¥‡å¹»">å¥‡å¹»</option>
                                    <option value="æ‚¬ç–‘">æ‚¬ç–‘</option>
                                    <option value="ç®¡ç†">ç®¡ç†</option>
                                    <option value="æ•ˆç‡">æ•ˆç‡</option>
                                    <option value="å•†ä¸š">å•†ä¸š</option>
                                    <option value="èŒåœº">èŒåœº</option>
                                    <option value="è‡ªæˆ‘æå‡">è‡ªæˆ‘æå‡</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bookLanguage">åŸå§‹è¯­è¨€</label>
                                <select id="bookLanguage">
                                    <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                    <option value="è‹±æ–‡">è‹±æ–‡</option>
                                    <option value="æ³•æ–‡">æ³•æ–‡</option>
                                    <option value="å¾·æ–‡">å¾·æ–‡</option>
                                    <option value="æ—¥æ–‡">æ—¥æ–‡</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="bookDescription">ä¹¦ç±ç®€ä»‹æˆ–æ ¸å¿ƒå†…å®¹</label>
                            <textarea id="bookDescription" placeholder="è¯·ç®€è¦æè¿°ä¹¦ç±çš„ä¸»è¦å†…å®¹ã€ä¸»é¢˜æˆ–ç‰¹è‰²..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="userIntent">æ‚¨å¸Œæœ›çªå‡ºä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</label>
                            <textarea id="userIntent" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›çªå‡ºä¹¦ä¸­çš„äººç”Ÿå“²ç†ã€æƒ…æ„Ÿå…±é¸£ã€å®ç”¨ä»·å€¼ç­‰..."></textarea>
                        </div>
                    </form>
                </div>

                <!-- æ­¥éª¤2ï¼šæ–¹æ³•è®ºé€‰æ‹© -->
                <div class="wizard-step" data-step="2">
                    <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">ğŸ­ é€‰æ‹©ä»‹ç»æ–¹æ³•è®º</h2>
                    <p style="margin-bottom: 2rem; color: #6c757d; line-height: 1.6;">
                        æ ¹æ®æ‚¨çš„ä¹¦ç±ç±»å‹ï¼Œæˆ‘ä»¬æ¨èä»¥ä¸‹ä»‹ç»æ–¹æ³•è®ºã€‚æ¯ç§æ–¹æ³•è®ºéƒ½æœ‰ç‹¬ç‰¹çš„é£æ ¼å’Œé€‚ç”¨åœºæ™¯ã€‚
                    </p>
                    
                    <div class="methodology-grid" id="methodologyGrid">
                        <!-- æ–¹æ³•è®ºå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ­¥éª¤3ï¼šé£æ ¼é…ç½® -->
                <div class="wizard-step" data-step="3">
                    <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">ğŸ¨ ä¸ªæ€§åŒ–é£æ ¼é…ç½®</h2>
                    
                    <div class="style-config">
                        <!-- è¯­éŸ³é£æ ¼ -->
                        <div class="style-section">
                            <h3>ğŸ™ï¸ è¯­éŸ³é£æ ¼</h3>
                            <div class="style-options" id="voiceOptions">
                                <!-- è¯­éŸ³é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- è§†é¢‘é£æ ¼ -->
                        <div class="style-section">
                            <h3>ğŸ¬ è§†é¢‘é£æ ¼</h3>
                            <div class="style-options" id="videoOptions">
                                <!-- è§†é¢‘é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="wizard-actions">
                    <button class="btn btn-outline" id="prevBtn" onclick="previousStep()" style="display: none;">
                        â† ä¸Šä¸€æ­¥
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="saveAsDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                            ä¸‹ä¸€æ­¥ â†’
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStep = 1;
        let maxSteps = 3;
        let selectedMethodology = null;
        let selectedVoiceStyle = null;
        let selectedVideoStyle = null;

        // æ–¹æ³•è®ºæ•°æ®
        const methodologies = {
            "dongyu_literature": {
                "name": "è‘£å®‡è¾‰å¼æ–‡å­¦ä½œå“ä»‹ç»",
                "description": "æ·±åº¦æƒ…æ„Ÿå…±é¸£ï¼Œå¤ä»Šä¸­å¤–å¼•ç”¨ï¼Œç²¾ç¥è´¢å¯ŒæŒ–æ˜",
                "icon": "ğŸ“š",
                "color": "#8B5A3C",
                "suitable_categories": ["æ–‡å­¦ç±»", "å°è¯´", "æ•£æ–‡", "è¯—æ­Œ"],
                "features": [
                    "æƒ…æ„Ÿå…±é¸£å¼€åœº",
                    "ä¸ªäººç»å†æ¤å…¥", 
                    "å¤ä»Šä¸­å¤–å¼•ç”¨",
                    "å“²å­¦æ€è¾¨æ·±åº¦",
                    "ç²¾ç¥ä»·å€¼å‡å"
                ]
            },
            "dongyu_autobiography": {
                "name": "è‘£å®‡è¾‰å¼è‡ªä¼ ä½“ä»‹ç»",
                "description": "äººç”Ÿè½¨è¿¹é‡æ„ï¼Œå…³é”®é€‰æ‹©åˆ†æï¼Œæˆé•¿æ™ºæ…§æå–",
                "icon": "ğŸ¯",
                "color": "#2E7D32",
                "suitable_categories": ["ä¼ è®°", "è‡ªä¼ ", "å›å¿†å½•", "äººç‰©ä¼ è®°"],
                "features": [
                    "åå·®æ„Ÿåˆ¶é€ ",
                    "äººç”Ÿè½¨è¿¹é‡æ„",
                    "å…³é”®é€‰æ‹©åˆ†æ",
                    "æˆé•¿æ™ºæ…§æå–",
                    "åŠ±å¿—ä»·å€¼ä¼ é€’"
                ]
            },
            "dongyu_fiction": {
                "name": "è‘£å®‡è¾‰å¼è™šæ„ç±»ä»‹ç»",
                "description": "æƒ³è±¡åŠ›æ¿€å‘ï¼Œä¸–ç•Œè§‚æ„å»ºï¼Œç°å®æ€è€ƒå¼•å¯¼",
                "icon": "ğŸŒŸ",
                "color": "#7B1FA2",
                "suitable_categories": ["ç§‘å¹»", "å¥‡å¹»", "æ‚¬ç–‘", "ææ€–", "ç„å¹»"],
                "features": [
                    "æƒ³è±¡æƒ…å¢ƒå¼€åœº",
                    "ä¸–ç•Œè§‚æ„å»º",
                    "è§„åˆ™ä½“ç³»è§£æ",
                    "ç°å®å¯¹æ¯”æ€è€ƒ",
                    "æ€ç»´è¾¹ç•Œæ‹“å±•"
                ]
            },
            "luozhenyu_efficiency": {
                "name": "ç½—æŒ¯å®‡å¼æ•ˆç‡æå‡ä»‹ç»",
                "description": "è®¤çŸ¥å‡çº§è·¯å¾„ï¼Œæ—¶ä»£ç„¦è™‘è§£æï¼Œå®ç”¨æ–¹æ³•è®ºä¼ é€’",
                "icon": "âš¡",
                "color": "#FF6F00",
                "suitable_categories": ["ç®¡ç†", "æ•ˆç‡", "å•†ä¸š", "èŒåœº", "è‡ªæˆ‘æå‡"],
                "features": [
                    "å·®è·ç„¦è™‘åˆ¶é€ ",
                    "è®¤çŸ¥å‡çº§è·¯å¾„",
                    "æ–¹æ³•è®ºæ‹†è§£",
                    "åº•å±‚é€»è¾‘æ­ç¤º",
                    "è¡ŒåŠ¨æŒ‡å—æä¾›"
                ]
            }
        };

        // è¯­éŸ³é£æ ¼æ•°æ®
        const voiceStyles = {
            "dongyu_style": {
                "name": "è‘£å®‡è¾‰é£æ ¼",
                "description": "æ¸©å’Œäº²åˆ‡ï¼Œå¯Œæœ‰æ„ŸæŸ“åŠ›ï¼Œè¯­è°ƒèµ·ä¼è‡ªç„¶",
                "icon": "ğŸ­"
            },
            "luozhenyu_style": {
                "name": "ç½—æŒ¯å®‡é£æ ¼", 
                "description": "æ¿€æ˜‚æœ‰åŠ›ï¼ŒèŠ‚å¥æ˜å¿«ï¼Œé€»è¾‘æ¸…æ™°",
                "icon": "âš¡"
            },
            "professional_style": {
                "name": "ä¸“ä¸šæ’­éŸ³",
                "description": "æ ‡å‡†æ™®é€šè¯ï¼Œæ¸…æ™°å‡†ç¡®ï¼Œé€‚åˆæ­£å¼åœºåˆ",
                "icon": "ğŸ™ï¸"
            }
        };

        // è§†é¢‘é£æ ¼æ•°æ®
        const videoStyles = {
            "classic_ppt": {
                "name": "ç»å…¸PPTé£æ ¼",
                "description": "ç®€æ´å¤§æ–¹ï¼Œé€‚åˆå•†åŠ¡å’Œæ•™è‚²åœºæ™¯",
                "icon": "ğŸ“Š"
            },
            "modern_presentation": {
                "name": "ç°ä»£æ¼”ç¤ºé£æ ¼",
                "description": "æ—¶å°šåŠ¨æ„Ÿï¼Œè§†è§‰å†²å‡»åŠ›å¼º",
                "icon": "âœ¨"
            },
            "storytelling": {
                "name": "æ•…äº‹å™è¿°é£æ ¼",
                "description": "æ¸©é¦¨æ„Ÿäººï¼Œé€‚åˆæƒ…æ„Ÿç±»å†…å®¹",
                "icon": "ğŸ“–"
            }
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            initializeMethodologies();
            initializeStyleOptions();
            updateProgressIndicator();
        });

        // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                if (response.status === 401) {
                    // ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å¢å¼ºç”Ÿæˆå™¨');
                    window.location.href = '/login';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å¢å¼ºç”Ÿæˆå™¨');
                window.location.href = '/login';
                return false;
            }
        }

        // åˆå§‹åŒ–æ–¹æ³•è®º
        function initializeMethodologies() {
            const grid = document.getElementById('methodologyGrid');
            grid.innerHTML = '';

            Object.keys(methodologies).forEach(key => {
                const methodology = methodologies[key];
                const card = document.createElement('div');
                card.className = 'methodology-card';
                card.onclick = () => selectMethodology(key);

                card.innerHTML = `
                    <div class="methodology-header">
                        <div class="methodology-icon" style="background-color: ${methodology.color}20; color: ${methodology.color};">
                            ${methodology.icon}
                        </div>
                        <div>
                            <div class="methodology-title">${methodology.name}</div>
                        </div>
                    </div>
                    <div class="methodology-description">${methodology.description}</div>
                    <ul class="methodology-features">
                        ${methodology.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                `;

                grid.appendChild(card);
            });
        }

        // åˆå§‹åŒ–é£æ ¼é€‰é¡¹
        function initializeStyleOptions() {
            // è¯­éŸ³é£æ ¼
            const voiceContainer = document.getElementById('voiceOptions');
            Object.keys(voiceStyles).forEach(key => {
                const style = voiceStyles[key];
                const option = createStyleOption(key, style, 'voice');
                voiceContainer.appendChild(option);
            });

            // è§†é¢‘é£æ ¼
            const videoContainer = document.getElementById('videoOptions');
            Object.keys(videoStyles).forEach(key => {
                const style = videoStyles[key];
                const option = createStyleOption(key, style, 'video');
                videoContainer.appendChild(option);
            });
        }

        // åˆ›å»ºé£æ ¼é€‰é¡¹
        function createStyleOption(key, style, type) {
            const option = document.createElement('div');
            option.className = 'style-option';
            option.onclick = () => selectStyle(key, type);

            option.innerHTML = `
                <div class="style-option-icon">${style.icon}</div>
                <div class="style-option-info">
                    <h4>${style.name}</h4>
                    <p>${style.description}</p>
                </div>
            `;

            return option;
        }

        // é€‰æ‹©æ–¹æ³•è®º
        function selectMethodology(key) {
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.methodology-card').forEach(card => {
                card.classList.remove('selected');
            });

            // æ·»åŠ å½“å‰é€‰æ‹©
            event.currentTarget.classList.add('selected');
            selectedMethodology = key;
        }

        // é€‰æ‹©é£æ ¼
        function selectStyle(key, type) {
            const container = type === 'voice' ? '#voiceOptions' : '#videoOptions';
            
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll(`${container} .style-option`).forEach(option => {
                option.classList.remove('selected');
            });

            // æ·»åŠ å½“å‰é€‰æ‹©
            event.currentTarget.classList.add('selected');
            
            if (type === 'voice') {
                selectedVoiceStyle = key;
            } else {
                selectedVideoStyle = key;
            }
        }

        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (currentStep < maxSteps) {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateWizard();
                }
            } else {
                // æœ€åä¸€æ­¥ï¼Œå¼€å§‹ç”Ÿæˆ
                startGeneration();
            }
        }

        // ä¸Šä¸€æ­¥
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizard();
            }
        }

        // éªŒè¯å½“å‰æ­¥éª¤
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    const title = document.getElementById('bookTitle').value.trim();
                    if (!title) {
                        alert('è¯·è¾“å…¥ä¹¦ç±åç§°');
                        return false;
                    }
                    return true;
                case 2:
                    if (!selectedMethodology) {
                        alert('è¯·é€‰æ‹©ä¸€ç§ä»‹ç»æ–¹æ³•è®º');
                        return false;
                    }
                    return true;
                case 3:
                    return true; // é£æ ¼é…ç½®æ˜¯å¯é€‰çš„
                default:
                    return true;
            }
        }

        // æ›´æ–°å‘å¯¼ç•Œé¢
        function updateWizard() {
            // æ›´æ–°æ ‡ç­¾é¡µ
            document.querySelectorAll('.wizard-tab').forEach((tab, index) => {
                tab.classList.toggle('active', index + 1 === currentStep);
            });

            // æ›´æ–°æ­¥éª¤å†…å®¹
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                step.classList.toggle('active', index + 1 === currentStep);
            });

            // æ›´æ–°æŒ‰é’®
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            
            if (currentStep === maxSteps) {
                nextBtn.innerHTML = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-primary');
            } else {
                nextBtn.innerHTML = 'ä¸‹ä¸€æ­¥ â†’';
            }

            updateProgressIndicator();
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.toggle('active', stepNumber === currentStep);
                step.classList.toggle('completed', stepNumber < currentStep);
            });

            document.querySelectorAll('.progress-line').forEach((line, index) => {
                line.classList.toggle('completed', index + 1 < currentStep);
            });
        }

        // æ ‡ç­¾é¡µç‚¹å‡»
        document.querySelectorAll('.wizard-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetStep = parseInt(this.dataset.step);
                if (targetStep <= currentStep || validateStepsUpTo(targetStep - 1)) {
                    currentStep = targetStep;
                    updateWizard();
                }
            });
        });

        // éªŒè¯åˆ°æŒ‡å®šæ­¥éª¤çš„æ‰€æœ‰æ­¥éª¤
        function validateStepsUpTo(step) {
            for (let i = 1; i <= step; i++) {
                const originalStep = currentStep;
                currentStep = i;
                if (!validateCurrentStep()) {
                    currentStep = originalStep;
                    return false;
                }
            }
            return true;
        }

        // ä¿å­˜è‰ç¨¿
        function saveAsDraft() {
            const draft = {
                bookInfo: {
                    title: document.getElementById('bookTitle').value,
                    author: document.getElementById('bookAuthor').value,
                    category: document.getElementById('bookCategory').value,
                    language: document.getElementById('bookLanguage').value,
                    description: document.getElementById('bookDescription').value,
                    userIntent: document.getElementById('userIntent').value
                },
                selectedMethodology: selectedMethodology,
                selectedVoiceStyle: selectedVoiceStyle,
                selectedVideoStyle: selectedVideoStyle,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('fogsight_draft', JSON.stringify(draft));
            alert('è‰ç¨¿å·²ä¿å­˜ï¼');
        }

        // å¼€å§‹ç”Ÿæˆ
        function startGeneration() {
            const bookInfo = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                category: document.getElementById('bookCategory').value,
                language: document.getElementById('bookLanguage').value,
                description: document.getElementById('bookDescription').value,
                user_intent: document.getElementById('userIntent').value
            };

            const config = {
                methodology: selectedMethodology,
                voice_style: selectedVoiceStyle,
                video_style: selectedVideoStyle
            };

            // è¿™é‡Œå°†ä¸åç«¯APIé›†æˆ
            console.log('å¼€å§‹ç”Ÿæˆï¼Œé…ç½®å¦‚ä¸‹ï¼š', { bookInfo, config });
            
            // åˆ›å»ºç”Ÿæˆè¯·æ±‚æ•°æ®
            const requestData = {
                title: bookInfo.title,
                author: bookInfo.author,
                category: bookInfo.category,
                language: bookInfo.language,
                description: bookInfo.description,
                user_intent: bookInfo.user_intent,
                methodology: selectedMethodology || 'dongyu_literature',
                voice_style: selectedVoiceStyle || 'professional_style',
                video_style: selectedVideoStyle || 'classic_ppt',
                agent_type: 'exploration'
            };
            
            // æ˜¾ç¤ºç”Ÿæˆè¿›åº¦ç•Œé¢
            showGenerationProgress();
            
            // å‘èµ·ç”Ÿæˆè¯·æ±‚
            generateWithEnhancedAPI(requestData);
        }

        // æ ¹æ®ä¹¦ç±åˆ†ç±»æ¨èæ–¹æ³•è®º
        document.getElementById('bookCategory').addEventListener('change', function() {
            const category = this.value;
            if (!category) return;

            // é«˜äº®æ¨èçš„æ–¹æ³•è®º
            document.querySelectorAll('.methodology-card').forEach(card => {
                card.style.opacity = '0.5';
            });

            Object.keys(methodologies).forEach(key => {
                const methodology = methodologies[key];
                if (methodology.suitable_categories.some(cat => 
                    cat.toLowerCase().includes(category.toLowerCase()) || 
                    category.toLowerCase().includes(cat.toLowerCase())
                )) {
                    const card = document.querySelector(`.methodology-card:nth-child(${Object.keys(methodologies).indexOf(key) + 1})`);
                    if (card) {
                        card.style.opacity = '1';
                        card.style.border = '2px solid #28a745';
                    }
                }
            });

            // 3ç§’åæ¢å¤æ­£å¸¸
            setTimeout(() => {
                document.querySelectorAll('.methodology-card').forEach(card => {
                    card.style.opacity = '1';
                    card.style.border = '2px solid #e9ecef';
                });
            }, 3000);
        });

        // åŠ è½½è‰ç¨¿
        function loadDraft() {
            const draft = localStorage.getItem('fogsight_draft');
            if (draft) {
                const data = JSON.parse(draft);
                
                // å¡«å……ä¹¦ç±ä¿¡æ¯
                if (data.bookInfo) {
                    Object.keys(data.bookInfo).forEach(key => {
                        const element = document.getElementById('book' + key.charAt(0).toUpperCase() + key.slice(1));
                        if (element) {
                            element.value = data.bookInfo[key] || '';
                        }
                    });
                }

                // æ¢å¤é€‰æ‹©
                selectedMethodology = data.selectedMethodology;
                selectedVoiceStyle = data.selectedVoiceStyle;
                selectedVideoStyle = data.selectedVideoStyle;

                alert('è‰ç¨¿å·²åŠ è½½ï¼');
            }
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½è‰ç¨¿
        setTimeout(() => {
            if (localStorage.getItem('fogsight_draft') && 
                confirm('æ£€æµ‹åˆ°å·²ä¿å­˜çš„è‰ç¨¿ï¼Œæ˜¯å¦åŠ è½½ï¼Ÿ')) {
                loadDraft();
            }
        }, 1000);

        // ä½¿ç”¨å¢å¼ºAPIç”Ÿæˆ
        async function generateWithEnhancedAPI(requestData) {
            try {
                // ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
                const isAuthenticated = await checkAuthStatus();
                if (!isAuthenticated) {
                    return;
                }

                const response = await fetch('/api/enhanced-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // åŒ…å«cookiesä»¥è¿›è¡Œè®¤è¯
                    body: JSON.stringify(requestData)
                });

                if (response.status === 401) {
                    alert('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/login';
                    return;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleGenerationProgress(data);
                            } catch (e) {
                                console.error('è§£ææ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                showGenerationError(error.message);
            }
        }

        // æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
        function showGenerationProgress() {
            // éšè—é…ç½®ç•Œé¢
            document.querySelector('.generation-wizard').style.display = 'none';
            
            // åˆ›å»ºè¿›åº¦ç•Œé¢
            const progressHTML = `
                <div class="generation-progress">
                    <div class="progress-header">
                        <h2>ğŸš€ æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¹¦ç±ä»‹ç»...</h2>
                        <p>æ ¹æ®æ‚¨é€‰æ‹©çš„æ–¹æ³•è®ºå’Œé…ç½®ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨æ‰“é€ ä¸“ä¸šçš„å†…å®¹</p>
                    </div>
                    
                    <div class="progress-steps">
                        <div class="progress-step active" id="step-1">
                            <div class="step-icon">ğŸ“š</div>
                            <div class="step-info">
                                <h4>åˆ†æä¹¦ç±ä¿¡æ¯</h4>
                                <p>æ­£åœ¨å¤„ç†ä¹¦ç±å†…å®¹å’ŒèƒŒæ™¯ä¿¡æ¯...</p>
                            </div>
                        </div>
                        
                        <div class="progress-step" id="step-2">
                            <div class="step-icon">ğŸ­</div>
                            <div class="step-info">
                                <h4>åº”ç”¨ä»‹ç»æ–¹æ³•è®º</h4>
                                <p>æ ¹æ®é€‰å®šçš„æ–¹æ³•è®ºæ„å»ºä»‹ç»ç»“æ„...</p>
                            </div>
                        </div>
                        
                        <div class="progress-step" id="step-3">
                            <div class="step-icon">ğŸ¨</div>
                            <div class="step-info">
                                <h4>ç”Ÿæˆæ¼”ç¤ºå†…å®¹</h4>
                                <p>åˆ›å»ºå¹»ç¯ç‰‡å’Œæ¼”è®²ç¨¿...</p>
                            </div>
                        </div>
                        
                        <div class="progress-step" id="step-4">
                            <div class="step-icon">âœ¨</div>
                            <div class="step-info">
                                <h4>å®Œæˆåˆ¶ä½œ</h4>
                                <p>åº”ç”¨é£æ ¼é…ç½®ï¼Œç”Ÿæˆæœ€ç»ˆä½œå“...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-log" id="progressLog">
                        <!-- è¿›åº¦æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            `;
            
            document.querySelector('.container').innerHTML = progressHTML;
            
            // æ·»åŠ è¿›åº¦æ ·å¼
            addProgressStyles();
        }

        // å¤„ç†ç”Ÿæˆè¿›åº¦
        function handleGenerationProgress(data) {
            const progressLog = document.getElementById('progressLog');
            
            if (data.status) {
                // æ·»åŠ çŠ¶æ€æ¶ˆæ¯
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-time">${new Date().toLocaleTimeString()}</span>
                    <span class="log-message">${data.status}</span>
                `;
                progressLog.appendChild(logEntry);
                progressLog.scrollTop = progressLog.scrollHeight;
            }
            
            if (data.step) {
                // æ›´æ–°æ­¥éª¤çŠ¶æ€
                updateProgressStep(data.step);
            }
            
            if (data.session_id) {
                // ç”Ÿæˆå®Œæˆï¼Œè·³è½¬åˆ°ç»“æœé¡µé¢
                setTimeout(() => {
                    window.location.href = `/ppt-preview/${data.session_id}`;
                }, 2000);
            }
            
            if (data.error) {
                showGenerationError(data.error);
            }
        }

        // æ›´æ–°è¿›åº¦æ­¥éª¤
        function updateProgressStep(stepNumber) {
            // ç§»é™¤æ‰€æœ‰æ­¥éª¤çš„activeç±»
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // ä¸ºå½“å‰æ­¥éª¤åŠä¹‹å‰çš„æ­¥éª¤æ·»åŠ completedç±»
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step-${i}`);
                if (step) {
                    step.classList.add('completed');
                }
            }
            
            // ä¸ºå½“å‰æ­¥éª¤æ·»åŠ activeç±»
            const currentStep = document.getElementById(`step-${stepNumber}`);
            if (currentStep) {
                currentStep.classList.add('active');
            }
        }

        // æ˜¾ç¤ºç”Ÿæˆé”™è¯¯
        function showGenerationError(message) {
            const errorHTML = `
                <div class="generation-error">
                    <div class="error-icon">âŒ</div>
                    <h2>ç”Ÿæˆå¤±è´¥</h2>
                    <p>${message}</p>
                    <div class="error-actions">
                        <button class="btn btn-primary" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
                        <button class="btn btn-outline" onclick="window.location.href='/'">è¿”å›é¦–é¡µ</button>
                    </div>
                </div>
            `;
            
            document.querySelector('.container').innerHTML = errorHTML;
        }

        // æ·»åŠ è¿›åº¦æ ·å¼
        function addProgressStyles() {
            const styles = `
                <style>
                .generation-progress {
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 2rem;
                    text-align: center;
                }
                
                .progress-header h2 {
                    color: #2c3e50;
                    margin-bottom: 0.5rem;
                }
                
                .progress-header p {
                    color: #6c757d;
                    margin-bottom: 3rem;
                }
                
                .progress-steps {
                    display: grid;
                    gap: 2rem;
                    margin-bottom: 3rem;
                }
                
                .progress-step {
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    border-radius: 12px;
                    background: #f8f9fa;
                    text-align: left;
                    transition: all 0.3s ease;
                }
                
                .progress-step.active {
                    background: #e3f2fd;
                    border: 2px solid #2196f3;
                }
                
                .progress-step.completed {
                    background: #e8f5e8;
                    border: 2px solid #4caf50;
                }
                
                .step-icon {
                    font-size: 2rem;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                .step-info h4 {
                    margin: 0 0 0.25rem 0;
                    color: #2c3e50;
                }
                
                .step-info p {
                    margin: 0;
                    color: #6c757d;
                    font-size: 0.9rem;
                }
                
                .progress-log {
                    max-height: 200px;
                    overflow-y: auto;
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: left;
                }
                
                .log-entry {
                    display: flex;
                    gap: 1rem;
                    padding: 0.25rem 0;
                    border-bottom: 1px solid #e9ecef;
                }
                
                .log-time {
                    color: #6c757d;
                    font-size: 0.8rem;
                    min-width: 80px;
                }
                
                .log-message {
                    color: #2c3e50;
                    font-size: 0.9rem;
                }
                
                .generation-error {
                    text-align: center;
                    padding: 3rem;
                    max-width: 500px;
                    margin: 0 auto;
                }
                
                .error-icon {
                    font-size: 4rem;
                    margin-bottom: 1rem;
                }
                
                .error-actions {
                    display: flex;
                    gap: 1rem;
                    justify-content: center;
                    margin-top: 2rem;
                }
                
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.5; }
                    100% { opacity: 1; }
                }
                
                .progress-step.active .step-icon {
                    animation: pulse 2s infinite;
                }
                </style>
            `;
            
            document.head.insertAdjacentHTML('beforeend', styles);
        }
    </script>
</body>
</html>
