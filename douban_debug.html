<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>豆瓣</title>
    <style type="text/css">
        body{font-family:Arial,Helvetica,sans-serif;font-size:14px;}
    </style>
</head>
<body>
    <div>
        <div style="margin:20px auto;">
            <div style="font-size:25px;color:#1b9336;border-bottom:5px solid #eef9eb">
                <span style="font-size:20px;font-weight:bold">豆瓣</span> d<span style="color:#0092c8">o</span><span style="color:#ffad68">u</span><span>b</span><span style="color:#0092c8">a</span><span style="color:#ffad68">n</span>
            </div>
            <p>请点击下方按钮继续浏览或<a href="https://accounts.douban.com/passport/login?redir=https://www.douban.com/">登录</a>使用豆瓣</p>
            <form name="sec" id="sec" method="POST" action="/c">
              <input type="hidden" id="tok" name="tok" value="1756901891@02ed78f61846995fc12d55c7c7471774e77e32ffd6a6e34d5c7480179a867fa4d7aaf585f8f7b2d240436b4fe7453924b71521d97c831c74c1c1d0bccdc0bae2@aHR0cHM6Ly9zZWFyY2guZG91YmFuLmNvbS9ib29rL3N1YmplY3Rfc2VhcmNoP3NlYXJjaF90ZXh0PSVFNiVCNCVCQiVFNyU5RCU4MCZjYXQ9MTAwMQ==@6ff4320bb8d950d33c547da85ea013f19998665cf53ca12a0831c082fd8a953e" />
              <input type="hidden" id="cha" name="cha" value="571ca1a1a59d570d4165806d91954ac90a5377af801a86c47b0a92340fd9c788594ca90d07eb07faf8783d92fb0943f50b2983786afed1e23dc70c1df1803f5a" />
              <input type="hidden" id="sol" name="sol" value="" />
              <input type="hidden" id="red" name="red" value="https://search.douban.com/book/subject_search?search_text=%E6%B4%BB%E7%9D%80&cat=1001">
              <button type="submit" id="sub" name="btnsubmit">点我继续浏览</button>
            </form>
        </div>
    </div>
</body>
<script>
function sha512(string) {
    return new Promise((resolve, reject) => {
        let buffer = (new TextEncoder).encode(string);

        crypto.subtle.digest('SHA-512', buffer.buffer).then(result => {
            resolve(Array.from(new Uint8Array(result)).map(
                c => c.toString(16).padStart(2, '0')
            ).join(''));
        }, reject);
    });
}

async function process(data, difficulty = 4) {
    let hash;
    let nonce = 0;
    const targetSubStr = Array(difficulty+1).join('0');

    do {
        nonce += 1;
        hash = await sha512(data + nonce);
    } while(hash.substr(0, difficulty) !== targetSubStr);
    return nonce;
}

document.querySelector("#sec").addEventListener("submit", async function(e){
    e.preventDefault();
    const sub = document.querySelector("#sub");
    sub.disabled = true;
    const tok = document.querySelector("#tok").value;
    const cha = document.querySelector("#cha").value;
    let f = document.querySelector("#sol");
    let tt = 3;
    const loading = setInterval(() => {
      sub.innerHTML = "正在处理,请稍候 " + Array(tt).join('.');
      tt += 1;
      if (tt == 6) { tt = 3};
    }, 500);
    let s = await process(cha);
    f.value = s;
    clearInterval(loading);
    sub.innerHTML = "即将加载...";
    e.target.submit();
});
</script>
</html>

